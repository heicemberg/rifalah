(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[858],{2099:(e,s,r)=>{"use strict";r.d(s,{AG:()=>n,HF:()=>i,LC:()=>l,ND:()=>a,aE:()=>u,bf:()=>m,jB:()=>o,ru:()=>d,t1:()=>h,x$:()=>p,zk:()=>c});var t=r(7965);let a=t.LY,n=()=>t.LY,o=async()=>(await (0,t.wT)()).success,i=()=>({hasInstance:!0,attempts:0,url:"netlify-compatible",environment:"netlify-compatible",ready:!0}),l=t.wT;async function c(){try{let{data:e,error:s}=await a.from("customers").select("count",{count:"exact",head:!0});if(s){if(console.error("‚ùå Error de conexi\xf3n Supabase:",s.message),s.message.includes("database is paused")||s.message.includes("project is paused")||s.message.includes("timeout"))throw console.error("\uD83D\uDEA8 Base de datos pausada. Revisa tu plan de Supabase."),Error("Base de datos pausada. Contacta al administrador o actualiza el plan.");return!1}return console.log("‚úÖ Conexi\xf3n Supabase exitosa"),!0}catch(e){return console.error("‚ùå Error cr\xedtico de conexi\xf3n:",e),!1}}async function d(e){try{if(!await c())throw Error("No se pudo establecer conexi\xf3n con la base de datos. Intenta m\xe1s tarde.");console.log("\uD83D\uDCBE Guardando compra:",e);let{data:s,error:r}=await a.from("customers").insert([{name:`${e.nombre} ${e.apellidos}`,email:e.email,phone:e.telefono,city:e.ciudad,state:e.estado}]).select().single();if(r)throw console.error("‚ùå Error al crear cliente:",r),Error(`Error al crear cliente: ${r.message}`);let{data:t,error:n}=await a.from("purchases").insert([{customer_id:s.id,total_amount:e.precio_total,unit_price:e.precio_unitario,discount_applied:e.descuento_aplicado||0,payment_method:e.metodo_pago,payment_reference:e.referencia_pago,payment_proof_url:e.captura_comprobante_url,browser_info:e.navegador,device_info:e.dispositivo,ip_address:e.ip_address,user_agent:e.user_agent,status:"pendiente"}]).select().single();if(n)throw console.error("‚ùå Error al crear compra:",n),Error(`Error al crear compra: ${n.message}`);return console.log("‚úÖ Compra guardada exitosamente"),{customer:s,purchase:t,tickets:[]}}catch(e){throw console.error("‚ùå Error completo en guardarCompra:",e),e}}function m(){return{navegador:navigator.userAgent,dispositivo:/Mobi|Android/i.test(navigator.userAgent)?"m\xf3vil":"escritorio",user_agent:navigator.userAgent,timestamp:new Date().toISOString(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,idioma:navigator.language,pantalla:`${screen.width}x${screen.height}`}}async function u(e,s){try{let r=new Date().getTime(),t=e.name.split(".").pop(),n=`capturas/${s.replace(/\s+/g,"_")}_${r}.${t}`,{data:o,error:i}=await a.storage.from("comprobantes").upload(n,e);if(i)throw console.error("‚ùå Error al subir archivo:",i),i;let{data:l}=a.storage.from("comprobantes").getPublicUrl(n);return console.log("‚úÖ Archivo subido exitosamente"),l.publicUrl}catch(e){return console.error("‚ùå Error en subirCaptura:",e),null}}async function p(){try{let{data:e,error:s}=await a.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).order("created_at",{ascending:!1});if(s)throw console.error("‚ùå Error al obtener compras:",s),s;return e}catch(e){throw console.error("‚ùå Error en obtenerCompras:",e),e}}async function h(e,s,r,t){try{let{data:n,error:o}=await a.from("purchases").select(`
        *,
        customer:customers(*)
      `).eq("id",e).single();if(o)throw o;let i={status:s,notes:r,verified_by:t};"confirmada"===s&&(i.verified_at=new Date().toISOString());let{data:l,error:c}=await a.from("purchases").update(i).eq("id",e).select().single();if(c)throw c;let d=[];if("confirmada"===s){let s=Math.round(l.total_amount/l.unit_price);try{d=await x(e,l.customer_id,s),console.log(`‚úÖ Compra confirmada y ${d.length} tickets asignados`)}catch(s){throw console.error("‚ùå Error al asignar tickets:",s),await a.from("purchases").update({status:"pendiente"}).eq("id",e),Error(`No se pudo confirmar: ${s instanceof Error?s.message:"Error al asignar tickets"}`)}}"cancelada"===s&&(await a.from("tickets").update({status:"disponible",customer_id:null,purchase_id:null,sold_at:null}).eq("purchase_id",e),console.log("\uD83D\uDD04 Tickets liberados por cancelaci\xf3n"));let{data:m,error:u}=await a.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).eq("id",e).single();if(u)throw u;return console.log("‚úÖ Compra actualizada"),m}catch(e){throw console.error("‚ùå Error en actualizarEstadoCompra:",e),e}}async function x(e,s,r){try{let{data:t,error:n}=await a.from("tickets").select("*").eq("status","disponible").order("number").limit(r);if(n)throw n;if(!t||t.length<r)throw Error(`Solo hay ${t?.length||0} tickets disponibles, necesitas ${r}`);let o=t.map(e=>e.number),i=new Date().toISOString(),{data:l,error:c}=await a.from("tickets").update({status:"vendido",customer_id:s,purchase_id:e,sold_at:i}).in("number",o).select();if(c)throw c;return console.log(`‚úÖ Asignados ${l?.length} tickets:`,o),l||[]}catch(e){throw console.error("‚ùå Error al asignar n\xfameros:",e),e}}},3404:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>o});var t=r(5155),a=r(2115),n=r(2099);function o(){let[e,s]=(0,a.useState)(null),[r,o]=(0,a.useState)("‚è≥ Preparando..."),[i,l]=(0,a.useState)(!0);return((0,a.useEffect)(()=>{(async()=>{let e=[],r=[];try{let t;r.push("\uD83D\uDD04 Iniciando diagn\xf3stico...");let a={hasSupabaseUrl:!0,hasSupabaseKey:!0,supabaseUrlPreview:"https://ugmfmnwbynppdzkhvrih.supabase.co".substring(0,30)+"...",supabaseKeyPreview:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnbWZtbndieW5wcGR6a2h2cmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODE4NzAsImV4cCI6MjA3MTQ1Nzg3MH0.MTNKqQCzmRETjULZ2PRx8mTK3hpR90tn6Pz36h1nMR4".substring(0,15)+"...",nodeEnv:"production",userAgent:window.navigator.userAgent,location:window.location.href,isNetlify:window.location.hostname.includes("netlify"),windowSupabaseUrl:window.__SUPABASE_URL__,windowSupabaseKey:window.__SUPABASE_KEY__?.substring(0,15)+"...",hasWindowVars:!!window.__SUPABASE_URL__,buildTime:new Date().toISOString()};r.push("‚úÖ Informaci\xf3n del entorno recopilada");try{t=(0,n.HF)(),r.push("‚úÖ Estado de conexi\xf3n obtenido")}catch(s){t={hasInstance:!1,attempts:0,url:"Error getting status",environment:"unknown"},e.push(`Error obteniendo estado: ${s}`)}s({environment:a,connection:t,errors:e,logs:r}),r.push("\uD83D\uDD04 Iniciando test de conexi\xf3n avanzado..."),o("\uD83D\uDD04 Probando conexi\xf3n a Supabase...");try{let s=await (0,n.LC)();s.success?(r.push("‚úÖ Test de conexi\xf3n exitoso"),o("‚úÖ Conexi\xf3n exitosa a Supabase - Database respondiendo correctamente")):(r.push(`‚ùå Test de conexi\xf3n fall\xf3: ${s.error}`),o(`‚ùå Error: ${s.error}`),e.push(`Test de conexi\xf3n fall\xf3: ${s.error}`),s.details&&e.push(`Detalles: ${JSON.stringify(s.details,null,2)}`)),await (0,n.jB)()?r.push("‚úÖ Inicializaci\xf3n adicional exitosa"):r.push("‚ö†Ô∏è Inicializaci\xf3n adicional fall\xf3 pero conexi\xf3n directa funciona")}catch(s){r.push(`‚ùå Error cr\xedtico de conexi\xf3n: ${s}`),o(`‚ùå Error cr\xedtico: ${s}`),e.push(`Error cr\xedtico de conexi\xf3n: ${s}`)}s(s=>s?{...s,errors:e,logs:r}:null)}catch(s){console.error("Error en diagn\xf3stico:",s),o(`‚ùå Error general: ${s}`),e.push(`Error general: ${s}`)}finally{l(!1)}})()},[]),i)?(0,t.jsx)("div",{className:"min-h-screen bg-gray-900 text-white p-8",children:(0,t.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-yellow-500 mx-auto"}),(0,t.jsx)("h1",{className:"text-3xl font-bold mt-8",children:"Ejecutando Diagn\xf3stico..."})]})})}):(0,t.jsx)("div",{className:"min-h-screen bg-gray-900 text-white p-8",children:(0,t.jsxs)("div",{className:"max-w-4xl mx-auto space-y-8",children:[(0,t.jsxs)("div",{className:"text-center border-b border-gray-700 pb-8",children:[(0,t.jsx)("h1",{className:"text-4xl font-bold text-yellow-500 mb-4",children:"\uD83D\uDD0D Debug Netlify - Rifa Silverado Z71"}),(0,t.jsx)("p",{className:"text-gray-300",children:"Diagn\xf3stico de conexi\xf3n Supabase en Netlify"})]}),(0,t.jsxs)("div",{className:"bg-gray-800 rounded-lg p-6",children:[(0,t.jsx)("h2",{className:"text-2xl font-bold text-yellow-500 mb-4",children:"\uD83D\uDD17 Test de Conexi\xf3n"}),(0,t.jsx)("div",{className:"text-xl p-4 rounded bg-gray-700",children:r})]}),e&&(0,t.jsxs)("div",{className:"bg-gray-800 rounded-lg p-6",children:[(0,t.jsx)("h2",{className:"text-2xl font-bold text-blue-400 mb-4",children:"\uD83C\uDF0D Variables de Entorno"}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-semibold",children:"NODE_ENV:"}),(0,t.jsx)("span",{className:"ml-2 text-yellow-400",children:e.environment.nodeEnv})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-semibold",children:"Es Netlify:"}),(0,t.jsx)("span",{className:`ml-2 ${e.environment.isNetlify?"text-green-400":"text-gray-400"}`,children:e.environment.isNetlify?"‚úÖ S\xed":"‚ùå No"})]}),(0,t.jsxs)("div",{className:"md:col-span-2",children:[(0,t.jsx)("span",{className:"font-semibold",children:"User Agent:"}),(0,t.jsxs)("span",{className:"ml-2 text-gray-300 text-sm",children:[e.environment.userAgent.substring(0,80),"..."]})]})]}),(0,t.jsxs)("div",{className:"border-t border-gray-600 pt-4",children:[(0,t.jsx)("h4",{className:"text-lg font-semibold text-blue-300 mb-2",children:"Variables process.env"}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("span",{className:"font-semibold mr-2",children:"SUPABASE_URL:"}),e.environment.hasSupabaseUrl?(0,t.jsx)("span",{className:"text-green-400",children:"‚úÖ Configurada"}):(0,t.jsx)("span",{className:"text-red-400",children:"‚ùå NO configurada"}),(0,t.jsx)("span",{className:"ml-4 text-gray-300 font-mono text-sm",children:e.environment.supabaseUrlPreview})]}),(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("span",{className:"font-semibold mr-2",children:"SUPABASE_KEY:"}),e.environment.hasSupabaseKey?(0,t.jsx)("span",{className:"text-green-400",children:"‚úÖ Configurada"}):(0,t.jsx)("span",{className:"text-red-400",children:"‚ùå NO configurada"}),(0,t.jsx)("span",{className:"ml-4 text-gray-300 font-mono text-sm",children:e.environment.supabaseKeyPreview})]})]})]}),(0,t.jsxs)("div",{className:"border-t border-gray-600 pt-4",children:[(0,t.jsx)("h4",{className:"text-lg font-semibold text-purple-300 mb-2",children:"Variables window (Runtime)"}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center",children:[(0,t.jsx)("span",{className:"font-semibold mr-2",children:"Window Variables:"}),e.environment.hasWindowVars?(0,t.jsx)("span",{className:"text-green-400",children:"‚úÖ Disponibles"}):(0,t.jsx)("span",{className:"text-red-400",children:"‚ùå NO disponibles"})]}),(0,t.jsxs)("div",{className:"ml-4 space-y-1",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-mono text-sm text-gray-400",children:"__SUPABASE_URL__:"}),(0,t.jsxs)("span",{className:"ml-2 text-gray-300 font-mono text-xs",children:[e.environment.windowSupabaseUrl?.substring(0,40)||"N/A","..."]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-mono text-sm text-gray-400",children:"__SUPABASE_KEY__:"}),(0,t.jsx)("span",{className:"ml-2 text-gray-300 font-mono text-xs",children:e.environment.windowSupabaseKey||"N/A"})]})]})]})]}),(0,t.jsxs)("div",{className:"border-t border-gray-600 pt-4",children:[(0,t.jsx)("span",{className:"font-semibold text-gray-400",children:"Build Time:"}),(0,t.jsx)("span",{className:"ml-2 text-gray-300 font-mono text-sm",children:e.environment.buildTime})]})]})]}),e&&(0,t.jsxs)("div",{className:"bg-gray-800 rounded-lg p-6",children:[(0,t.jsx)("h2",{className:"text-2xl font-bold text-purple-400 mb-4",children:"‚ö° Estado de Conexi\xf3n Supabase"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-semibold",children:"Cliente Inicializado:"}),(0,t.jsx)("span",{className:`ml-2 ${e.connection.hasInstance?"text-green-400":"text-red-400"}`,children:e.connection.hasInstance?"‚úÖ S\xed":"‚ùå No"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:"font-semibold",children:"Intentos de Conexi\xf3n:"}),(0,t.jsx)("span",{className:"ml-2 text-yellow-400",children:e.connection.attempts})]}),(0,t.jsxs)("div",{className:"md:col-span-2",children:[(0,t.jsx)("span",{className:"font-semibold",children:"URL:"}),(0,t.jsx)("span",{className:"ml-2 text-gray-300 font-mono text-sm",children:e.connection.url})]})]})]}),e&&e.errors.length>0&&(0,t.jsxs)("div",{className:"bg-red-900/50 border border-red-500 rounded-lg p-6",children:[(0,t.jsx)("h2",{className:"text-2xl font-bold text-red-400 mb-4",children:"‚ùå Errores Detectados"}),(0,t.jsx)("div",{className:"space-y-2",children:e.errors.map((e,s)=>(0,t.jsx)("div",{className:"bg-red-800/50 p-3 rounded font-mono text-sm",children:e},s))})]}),e&&(0,t.jsxs)("div",{className:"bg-gray-800 rounded-lg p-6",children:[(0,t.jsx)("h2",{className:"text-2xl font-bold text-green-400 mb-4",children:"\uD83D\uDCCB Logs de Diagn\xf3stico"}),(0,t.jsx)("div",{className:"space-y-1 max-h-64 overflow-y-auto",children:e.logs.map((e,s)=>(0,t.jsx)("div",{className:"text-sm font-mono text-gray-300 p-1",children:e},s))})]}),(0,t.jsxs)("div",{className:"bg-gray-800 rounded-lg p-6",children:[(0,t.jsx)("h2",{className:"text-2xl font-bold text-orange-400 mb-4",children:"\uD83D\uDD27 Manual de Soluci\xf3n"}),(0,t.jsxs)("div",{className:"prose prose-invert text-sm space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-yellow-400",children:"1. Variables de Entorno en Netlify"}),(0,t.jsxs)("p",{children:["Ve a: ",(0,t.jsx)("code",{className:"bg-gray-700 px-2 py-1 rounded",children:"Site Settings ‚Üí Environment Variables"})]}),(0,t.jsxs)("ul",{className:"list-disc list-inside space-y-1 text-gray-300",children:[(0,t.jsx)("li",{children:"NEXT_PUBLIC_SUPABASE_URL = https://ugmfmnwbynppdzkhvrih.supabase.co"}),(0,t.jsx)("li",{children:"NEXT_PUBLIC_SUPABASE_ANON_KEY = (tu clave completa)"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-yellow-400",children:"2. Redeploy"}),(0,t.jsxs)("p",{children:["Despu\xe9s de configurar las variables, haz un ",(0,t.jsx)("strong",{children:"nuevo deploy"})," (no republish)"]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-yellow-400",children:"3. Verificar Logs"}),(0,t.jsx)("p",{children:"Revisa los logs de deploy y function logs en Netlify Dashboard"})]})]})]}),(0,t.jsxs)("div",{className:"text-center text-gray-500 text-sm border-t border-gray-700 pt-8",children:[(0,t.jsxs)("p",{children:["Generado: ",new Date().toLocaleString()]}),(0,t.jsx)("p",{children:"Rifa Silverado Z71 2024 - Debug v1.0"})]})]})})}},6423:(e,s,r)=>{Promise.resolve().then(r.bind(r,3404))},7965:(e,s,r)=>{"use strict";r.d(s,{LY:()=>d,wT:()=>c});var t=r(2354),a=r(7358);let n={ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnbWZtbndieW5wcGR6a2h2cmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODE4NzAsImV4cCI6MjA3MTQ1Nzg3MH0.MTNKqQCzmRETjULZ2PRx8mTK3hpR90tn6Pz36h1nMR4",URLS:{DIRECT:"https://ugmfmnwbynppdzkhvrih.supabase.co",POOLER_SESSION:"https://aws-0-us-east-1.pooler.supabase.com",POOLER_TRANSACTION:"https://aws-0-us-east-1.pooler.supabase.com"}};function o(){let e=!!("true"===a.env.NETLIFY||a.env.CONTEXT||a.env.NETLIFY_DEV||window.__NETLIFY__);return{isNetlify:e,hasIPv6Support:"onLine"in navigator,isBuildTime:!1,context:a.env.CONTEXT||"unknown"}}let i=null;function l(){if(i)return i;let e=o(),s=function(){let e=o();return(console.log("\uD83D\uDD0D Environment detection:",e),e.isNetlify)?console.log("\uD83C\uDF10 Using Supavisor Pooler (IPv4) for Netlify compatibility"):console.log("\uD83C\uDF10 Using Direct Connection for local/other environments"),n.URLS.DIRECT}(),r=n.ANON_KEY,a={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!1,flowType:"pkce"},realtime:{params:{eventsPerSecond:e.isNetlify?1:2}},global:{headers:{"X-Client-Info":"rifa-silverado-netlify@1.0.0","User-Agent":"RifaApp-Netlify/1.0",...e.isNetlify&&{"X-Netlify-Context":e.context,"X-IPv4-Required":"true","X-Pooler-Mode":"session"}},fetch:e.isNetlify?async(e,s)=>{let r=new AbortController,t=setTimeout(()=>r.abort(),6e4);try{let t=await fetch(e,{...s,signal:r.signal,headers:{...s?.headers,Connection:"keep-alive","Cache-Control":"no-cache","Accept-Encoding":"gzip, deflate, br",Accept:"application/json, text/plain, */*"}}),a="string"==typeof e?e:e instanceof URL?e.toString():"request";return console.log(`üì° Supabase request: ${a.substring(0,50)}... ‚Üí ${t.status}`),t}catch(e){throw console.error("‚ùå Netlify Supabase request failed:",e),e}finally{clearTimeout(t)}}:void 0}};return console.log("\uD83D\uDE80 Creating Netlify-compatible Supabase client:",{url:s.substring(0,40)+"...",environment:e,config:"netlify-optimized"}),i=(0,t.UU)(s,r,a)}async function c(){try{let e=l(),s=o();console.log("\uD83E\uDDEA Testing Netlify Supabase connection...");let r=Date.now(),{data:t,error:a}=await e.from("customers").select("count",{count:"exact",head:!0}).limit(1),n=Date.now()-r;if(a){console.error("‚ùå Netlify connection test failed:",a);let e=a.message;return a.message.includes("ENOTFOUND")||a.message.includes("getaddrinfo")?e=`DNS resolution failed - probablemente IPv6 incompatibility en Netlify. Error original: ${a.message}`:a.message.includes("timeout")?e=`Connection timeout en Netlify (${n}ms). Prueba usar Supavisor Pooler.`:a.message.includes("ECONNREFUSED")&&(e="Connection refused - IPv6 address not reachable from Netlify."),{success:!1,error:e,details:{originalError:a.message,environment:s,duration:n,suggestedSolution:"Use IPv4 Supavisor Pooler instead of Direct Connection"}}}return console.log(`‚úÖ Netlify Supabase connection successful (${n}ms)`),{success:!0,details:{environment:s,duration:n,connectionType:s.isNetlify?"ipv4-pooler":"direct"}}}catch(e){return console.error("‚ùå Critical Netlify connection error:",e),{success:!1,error:`Critical error: ${e instanceof Error?e.message:"Unknown error"}`,details:{error:e}}}}let d=l()}},e=>{e.O(0,[354,441,964,358],()=>e(e.s=6423)),_N_E=e.O()}]);