(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[415],{2099:(e,r,t)=>{"use strict";t.d(r,{AG:()=>a,HF:()=>i,LC:()=>c,ND:()=>s,aE:()=>m,bf:()=>u,jB:()=>n,ru:()=>d,t1:()=>g,x$:()=>p,zk:()=>l});var o=t(7965);let s=o.LY,a=()=>o.LY,n=async()=>(await (0,o.wT)()).success,i=()=>({hasInstance:!0,attempts:0,url:"netlify-compatible",environment:"netlify-compatible",ready:!0}),c=o.wT;async function l(){try{let{data:e,error:r}=await s.from("customers").select("count",{count:"exact",head:!0});if(r){if(console.error("‚ùå Error de conexi\xf3n Supabase:",r.message),r.message.includes("database is paused")||r.message.includes("project is paused")||r.message.includes("timeout"))throw console.error("\uD83D\uDEA8 Base de datos pausada. Revisa tu plan de Supabase."),Error("Base de datos pausada. Contacta al administrador o actualiza el plan.");return!1}return console.log("‚úÖ Conexi\xf3n Supabase exitosa"),!0}catch(e){return console.error("‚ùå Error cr\xedtico de conexi\xf3n:",e),!1}}async function d(e){try{if(!await l())throw Error("No se pudo establecer conexi\xf3n con la base de datos. Intenta m\xe1s tarde.");console.log("\uD83D\uDCBE Guardando compra:",e);let{data:r,error:t}=await s.from("customers").insert([{name:`${e.nombre} ${e.apellidos}`,email:e.email,phone:e.telefono,city:e.ciudad,state:e.estado}]).select().single();if(t)throw console.error("‚ùå Error al crear cliente:",t),Error(`Error al crear cliente: ${t.message}`);let{data:o,error:a}=await s.from("purchases").insert([{customer_id:r.id,total_amount:e.precio_total,unit_price:e.precio_unitario,discount_applied:e.descuento_aplicado||0,payment_method:e.metodo_pago,payment_reference:e.referencia_pago,payment_proof_url:e.captura_comprobante_url,browser_info:e.navegador,device_info:e.dispositivo,ip_address:e.ip_address,user_agent:e.user_agent,status:"pendiente"}]).select().single();if(a)throw console.error("‚ùå Error al crear compra:",a),Error(`Error al crear compra: ${a.message}`);return console.log("‚úÖ Compra guardada exitosamente"),{customer:r,purchase:o,tickets:[]}}catch(e){throw console.error("‚ùå Error completo en guardarCompra:",e),e}}function u(){return{navegador:navigator.userAgent,dispositivo:/Mobi|Android/i.test(navigator.userAgent)?"m\xf3vil":"escritorio",user_agent:navigator.userAgent,timestamp:new Date().toISOString(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,idioma:navigator.language,pantalla:`${screen.width}x${screen.height}`}}async function m(e,r){try{let t=new Date().getTime(),o=e.name.split(".").pop(),a=`capturas/${r.replace(/\s+/g,"_")}_${t}.${o}`,{data:n,error:i}=await s.storage.from("comprobantes").upload(a,e);if(i)throw console.error("‚ùå Error al subir archivo:",i),i;let{data:c}=s.storage.from("comprobantes").getPublicUrl(a);return console.log("‚úÖ Archivo subido exitosamente"),c.publicUrl}catch(e){return console.error("‚ùå Error en subirCaptura:",e),null}}async function p(){try{let{data:e,error:r}=await s.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).order("created_at",{ascending:!1});if(r)throw console.error("‚ùå Error al obtener compras:",r),r;return e}catch(e){throw console.error("‚ùå Error en obtenerCompras:",e),e}}async function g(e,r,t,o){try{let{data:a,error:n}=await s.from("purchases").select(`
        *,
        customer:customers(*)
      `).eq("id",e).single();if(n)throw n;let i={status:r,notes:t,verified_by:o};"confirmada"===r&&(i.verified_at=new Date().toISOString());let{data:c,error:l}=await s.from("purchases").update(i).eq("id",e).select().single();if(l)throw l;let d=[];if("confirmada"===r){let r=Math.round(c.total_amount/c.unit_price);try{d=await f(e,c.customer_id,r),console.log(`‚úÖ Compra confirmada y ${d.length} tickets asignados`)}catch(r){throw console.error("‚ùå Error al asignar tickets:",r),await s.from("purchases").update({status:"pendiente"}).eq("id",e),Error(`No se pudo confirmar: ${r instanceof Error?r.message:"Error al asignar tickets"}`)}}"cancelada"===r&&(await s.from("tickets").update({status:"disponible",customer_id:null,purchase_id:null,sold_at:null}).eq("purchase_id",e),console.log("\uD83D\uDD04 Tickets liberados por cancelaci\xf3n"));let{data:u,error:m}=await s.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).eq("id",e).single();if(m)throw m;return console.log("‚úÖ Compra actualizada"),u}catch(e){throw console.error("‚ùå Error en actualizarEstadoCompra:",e),e}}async function f(e,r,t){try{let{data:o,error:a}=await s.from("tickets").select("*").eq("status","disponible").order("number").limit(t);if(a)throw a;if(!o||o.length<t)throw Error(`Solo hay ${o?.length||0} tickets disponibles, necesitas ${t}`);let n=o.map(e=>e.number),i=new Date().toISOString(),{data:c,error:l}=await s.from("tickets").update({status:"vendido",customer_id:r,purchase_id:e,sold_at:i}).in("number",n).select();if(l)throw l;return console.log(`‚úÖ Asignados ${c?.length} tickets:`,n),c||[]}catch(e){throw console.error("‚ùå Error al asignar n\xfameros:",e),e}}},4482:(e,r,t)=>{Promise.resolve().then(t.bind(t,7277))},7277:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>c});var o=t(5155),s=t(2115),a=t(7965),n=t(2099),i=t(7358);function c(){let[e,r]=(0,s.useState)(null),[t,c]=(0,s.useState)(!1),[l,d]=(0,s.useState)(null);(0,s.useEffect)(()=>{d({isNetlify:!!("true"===i.env.NETLIFY||i.env.CONTEXT),hasWindow:!0,userAgent:navigator.userAgent,timestamp:new Date().toISOString()})},[]);let u=async()=>{c(!0);try{let e;console.log("\uD83E\uDDEA Iniciando test completo de conexi\xf3n...");let t=await (0,a.wT)();try{e=await (0,n.zk)()}catch(r){e={success:!1,error:r instanceof Error?r.message:"Error legacy connection"}}let o={netlifyOptimized:t,legacyConnection:{success:e},comparison:{improvement:t.success&&!e?"FIXED":t.success===e?"SAME":"REGRESSION",recommendation:t.success?"Usar configuraci\xf3n optimizada para Netlify":"Revisar configuraci\xf3n IPv6"},timestamp:new Date().toISOString()};r(o),console.log("\uD83D\uDCCA Test completo:",o)}catch(e){console.error("‚ùå Error en test:",e),r({error:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()})}finally{c(!1)}};return(0,o.jsx)("div",{className:"min-h-screen bg-gray-50 p-8",children:(0,o.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,o.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[(0,o.jsx)("h1",{className:"text-3xl font-bold text-gray-800 mb-6",children:"\uD83D\uDD2C Test Soluci\xf3n IPv6/Netlify"}),(0,o.jsxs)("div",{className:"mb-6",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold text-gray-700 mb-3",children:"Informaci\xf3n del Entorno"}),(0,o.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded p-4",children:(0,o.jsx)("pre",{className:"text-sm text-blue-800 whitespace-pre-wrap",children:l?JSON.stringify(l,null,2):"Cargando..."})})]}),(0,o.jsx)("div",{className:"mb-6",children:(0,o.jsx)("button",{onClick:u,disabled:t,className:`px-6 py-3 rounded-lg font-semibold text-white transition-colors ${t?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"}`,children:t?"\uD83D\uDD04 Probando conexi\xf3n...":"\uD83E\uDDEA Ejecutar Test de Conexi\xf3n"})}),e&&(0,o.jsxs)("div",{className:"space-y-4",children:[(0,o.jsx)("h2",{className:"text-xl font-semibold text-gray-700",children:"Resultados del Test"}),(0,o.jsxs)("div",{className:`border rounded-lg p-4 ${e.netlifyOptimized?.success?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:[(0,o.jsx)("h3",{className:"font-semibold mb-2",children:e.netlifyOptimized?.success?"‚úÖ Conexi\xf3n Exitosa":"‚ùå Conexi\xf3n Fallida"}),(0,o.jsx)("p",{className:"text-sm text-gray-700",children:e.netlifyOptimized?.success?"La nueva configuraci\xf3n IPv4/Netlify funciona correctamente":`Error: ${e.netlifyOptimized?.error||"Error desconocido"}`})]}),e.comparison&&(0,o.jsxs)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[(0,o.jsx)("h3",{className:"font-semibold mb-2",children:"\uD83D\uDCCA An\xe1lisis de Mejora"}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Resultado:"})," ",e.comparison.improvement]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Recomendaci\xf3n:"})," ",e.comparison.recommendation]})]}),(0,o.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[(0,o.jsx)("h3",{className:"font-semibold mb-2",children:"\uD83D\uDD27 Detalles T\xe9cnicos"}),(0,o.jsx)("pre",{className:"text-xs text-gray-600 whitespace-pre-wrap overflow-auto max-h-64",children:JSON.stringify(e,null,2)})]}),(0,o.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[(0,o.jsx)("h3",{className:"font-semibold mb-2 text-blue-800",children:"\uD83D\uDCA1 Explicaci\xf3n de la Soluci\xf3n"}),(0,o.jsxs)("div",{className:"text-sm text-blue-700 space-y-2",children:[(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Problema:"})," Netlify no soporta IPv6 nativamente, pero Supabase Direct Connection usa IPv6"]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Soluci\xf3n:"})," Detecci\xf3n autom\xe1tica de entorno Netlify y configuraci\xf3n optimizada"]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"T\xe9cnica:"})," Headers especiales, timeouts extendidos, y fetch optimizado"]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Resultado esperado:"})," Conexi\xf3n estable en Netlify sin cambios en desarrollo local"]})]})]})]})]})})})}},7965:(e,r,t)=>{"use strict";t.d(r,{LY:()=>d,wT:()=>l});var o=t(2354),s=t(7358);let a={ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnbWZtbndieW5wcGR6a2h2cmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODE4NzAsImV4cCI6MjA3MTQ1Nzg3MH0.MTNKqQCzmRETjULZ2PRx8mTK3hpR90tn6Pz36h1nMR4",URLS:{DIRECT:"https://ugmfmnwbynppdzkhvrih.supabase.co",POOLER_SESSION:"https://aws-0-us-east-1.pooler.supabase.com",POOLER_TRANSACTION:"https://aws-0-us-east-1.pooler.supabase.com"}};function n(){let e=!!("true"===s.env.NETLIFY||s.env.CONTEXT||s.env.NETLIFY_DEV||window.__NETLIFY__);return{isNetlify:e,hasIPv6Support:"onLine"in navigator,isBuildTime:!1,context:s.env.CONTEXT||"unknown"}}let i=null;function c(){if(i)return i;let e=n(),r=function(){let e=n();return(console.log("\uD83D\uDD0D Environment detection:",e),e.isNetlify)?console.log("\uD83C\uDF10 Using Supavisor Pooler (IPv4) for Netlify compatibility"):console.log("\uD83C\uDF10 Using Direct Connection for local/other environments"),a.URLS.DIRECT}(),t=a.ANON_KEY,s={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!1,flowType:"pkce"},realtime:{params:{eventsPerSecond:e.isNetlify?1:2}},global:{headers:{"X-Client-Info":"rifa-silverado-netlify@1.0.0","User-Agent":"RifaApp-Netlify/1.0",...e.isNetlify&&{"X-Netlify-Context":e.context,"X-IPv4-Required":"true","X-Pooler-Mode":"session"}},fetch:e.isNetlify?async(e,r)=>{let t=new AbortController,o=setTimeout(()=>t.abort(),6e4);try{let o=await fetch(e,{...r,signal:t.signal,headers:{...r?.headers,Connection:"keep-alive","Cache-Control":"no-cache","Accept-Encoding":"gzip, deflate, br",Accept:"application/json, text/plain, */*"}}),s="string"==typeof e?e:e instanceof URL?e.toString():"request";return console.log(`üì° Supabase request: ${s.substring(0,50)}... ‚Üí ${o.status}`),o}catch(e){throw console.error("‚ùå Netlify Supabase request failed:",e),e}finally{clearTimeout(o)}}:void 0}};return console.log("\uD83D\uDE80 Creating Netlify-compatible Supabase client:",{url:r.substring(0,40)+"...",environment:e,config:"netlify-optimized"}),i=(0,o.UU)(r,t,s)}async function l(){try{let e=c(),r=n();console.log("\uD83E\uDDEA Testing Netlify Supabase connection...");let t=Date.now(),{data:o,error:s}=await e.from("customers").select("count",{count:"exact",head:!0}).limit(1),a=Date.now()-t;if(s){console.error("‚ùå Netlify connection test failed:",s);let e=s.message;return s.message.includes("ENOTFOUND")||s.message.includes("getaddrinfo")?e=`DNS resolution failed - probablemente IPv6 incompatibility en Netlify. Error original: ${s.message}`:s.message.includes("timeout")?e=`Connection timeout en Netlify (${a}ms). Prueba usar Supavisor Pooler.`:s.message.includes("ECONNREFUSED")&&(e="Connection refused - IPv6 address not reachable from Netlify."),{success:!1,error:e,details:{originalError:s.message,environment:r,duration:a,suggestedSolution:"Use IPv4 Supavisor Pooler instead of Direct Connection"}}}return console.log(`‚úÖ Netlify Supabase connection successful (${a}ms)`),{success:!0,details:{environment:r,duration:a,connectionType:r.isNetlify?"ipv4-pooler":"direct"}}}catch(e){return console.error("‚ùå Critical Netlify connection error:",e),{success:!1,error:`Critical error: ${e instanceof Error?e.message:"Unknown error"}`,details:{error:e}}}}let d=c()}},e=>{e.O(0,[354,441,964,358],()=>e(e.s=4482)),_N_E=e.O()}]);